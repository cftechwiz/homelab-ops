---
# yaml-language-server: $schema=https://kubernetes-schemas.falhalla.com/helmrelease_v2beta1.json
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: sumologic
  namespace: monitoring
spec:
  interval: 15m
  chart:
    spec:
      chart: sumologic
      version: 3.2.0
      sourceRef:
        kind: HelmRepository
        name: sumologic
        namespace: flux-system
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    sumologic:
      setupEnabled: true
      cleanupEnabled: false
      envFromSecret: sumologic-secret
      collectorName: homelab-ops
      clusterName: homelab
    events:
      persistence:
        persistentVolume:
          enabled: true
          storageClass: ceph-block
          accessMode: ReadWriteOnce
          size: 10g
    logs:
      multiline:
        enabled: true
        first_line_regex: "^\\[?\\d{4}-\\d{1,2}-\\d{1,2}.\\d{2}:\\d{2}:\\d{2}"
    metrics:
      remoteWriteProxy:
        resources:
          limits:
            cpu:
            memory: 256Mi
          requests:
            cpu:
            memory: 128Mi
    kube-prometheus-stack:
      prometheusOperator:
        resources:
          limits:
            cpu:
            memory: 200Mi
          requests:
            cpu:
            memory: 100Mi
      prometheus-node-exporter:
        resources:
          limits:
            cpu:
            memory: 50Mi
          requests:
            cpu:
            memory: 30Mi
      kube-state-metrics:
        resources:
          limits:
            cpu:
            memory: 200Mi
          requests:
            cpu:
            memory: 32Mi
    otelcolInstrumentation:
      statefulset:
        resources:
          limits:
            cpu:
            memory: 4Gi
          requests:
            cpu:
            memory: 768Mi
    tracesSampler:
      deployment:
        resources:
          limits:
            cpu:
            memory: 4Gi
          requests:
            cpu:
            memory: 384Mi
      config:
        receivers:
          otlp:
            protocols:
              grpc:
                endpoint: "localhost:4317"
              http:
                endpoint: "localhost:4318"
    metadata:
      metrics:
        statefulset:
          resources:
            limits:
              cpu:
              memory: 1Gi
            requests:
              cpu:
              memory: 768Mi
      logs:
        statefulset:
          resources:
            limits:
              cpu:
              memory: 1Gi
            requests:
              cpu:
              memory: 768Mi
    traceGateway:
      deployment:
        resources:
          limits:
            cpu:
            memory: 2Gi
          requests:
            cpu:
            memory: 196Mi
      config:
        receivers:
          otlp:
            protocols:
              grpc:
                endpoint: "localhost:4317"
              http:
                endpoint: "localhost:4318"
                cors:
                  allowed_origins:
                    - "http://*"
                    - "https://*"
                  allowed_headers:
                    - "*"
    otelevents:
      statefulset:
        resources:
          limits:
            cpu:
            memory: 2Gi
          requests:
            cpu:
            memory: 200Mi
    otellogs:
      daemonset:
        resources:
          limits:
            cpu:
            memory: 1Gi
          requests:
            cpu:
            memory: 32Mi
    falco:
      enabled: true
    tailing-sidecar-operator:
      enabled: true
    opentelemetry-operator:
      enabled: true
      createDefaultInstrumentation: true
      instrumentationNamespaces: "default"
