---
# yaml-language-server: $schema=https://kubernetes-schemas.falhalla.com/helmrelease_v2beta1.json
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: sumologic
  namespace: monitoring
spec:
  interval: 15m
  chart:
    spec:
      chart: sumologic
      version: 3.3.0
      sourceRef:
        kind: HelmRepository
        name: sumologic
        namespace: flux-system
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    sumologic:
      setupEnabled: true
      cleanupEnabled: false
      envFromSecret: sumologic-secret
      collectorName: homelab-ops
      clusterName: homelab
      events:
        persistence:
          persistentVolume:
            enabled: true
            storageClass: ceph-block
            accessMode: ReadWriteOnce
            size: 10Gi
      logs:
        multiline:
          enabled: true
          first_line_regex: "^\\[?\\d{4}-\\d{1,2}-\\d{1,2}.\\d{2}:\\d{2}:\\d{2}"
      metrics:
        remoteWriteProxy:
          resources:
            limits:
              cpu:
              memory: 256Mi
            requests:
              cpu:
              memory: 128Mi
    metrics-server:
      enabled: false
    kube-prometheus-stack:
      alertmanager:
        enabled: true
      prometheusOperator:
        resources:
          limits:
            cpu: 200m
            memory: 200Mi
          requests:
            cpu: 100m
            memory: 100Mi
      kube-state-metrics:
        resources:
          limits:
            cpu: 100m
            memory: 64Mi
          requests:
            cpu: 10m
            memory: 32Mi
      prometheus-node-exporter:
        resources:
          limits:
            cpu: 200m
            memory: 50Mi
          requests:
            cpu: 100m
            memory: 30Mi
      prometheus:
        prometheusSpec:
          scrapeInterval: "15s"
          retention: "1d"
          resources:
            limits:
              cpu: 800m
              memory: 8Gi
            requests:
              cpu: 500m
              memory: 1Gi
          serviceMonitor:
            selfMonitor: true
    otelcolInstrumentation:
      statefulset:
        resources:
          limits:
            cpu: 400m
            memory: 4Gi
          requests:
            cpu: 50m
            memory: 768Mi
    tracesSampler:
      deployment:
        resources:
          limits:
            cpu: 200m
            memory: 4Gi
          requests:
            cpu: 100m
            memory: 384Mi
      config:
        receivers:
          otlp:
            protocols:
              grpc:
                endpoint: "localhost:4317"
              http:
                endpoint: "localhost:4318"
    metadata:
      persistence:
        enabled: true
        storageClass: ceph-block
        accessMode: ReadWriteOnce
        size: 10Gi
      metrics:
        logLevel: debug
        statefulset:
          resources:
            limits:
              cpu: 1000m
              memory: 1Gi
            requests:
              cpu: 100m
              memory: 768Mi
        # autoscaling:
        #   enabled: true
        #   minReplicas: 3
        #   maxReplicas: 10
        #   targetCPUUtilizationPercentage: 80
      logs:
        logLevel: debug
        statefulset:
          resources:
            limits:
              cpu: 200m
              memory: 1Gi
            requests:
              cpu: 100m
              memory: 768Mi
        # autoscaling:
        #   enabled: true
        #   minReplicas: 3
        #   maxReplicas: 10
        #   targetCPUUtilizationPercentage: 80
    traceGateway:
      enabled: false
      deployment:
        resources:
          limits:
            cpu: 200m
            memory: 2Gi
          requests:
            cpu: 100m
            memory: 196Mi
      config:
        receivers:
          otlp:
            protocols:
              http:
                cors:
                  allowed_origins:
                    - "http://*"
                    - "https://*"
                  allowed_headers:
                    - "*"
    otelevents:
      logLevel: debug
      statefulset:
        resources:
          limits:
            cpu: 200m
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 200Mi
    otellogs:
      logLevel: debug
      daemonset:
        resources:
          limits:
            cpu: 1000m
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 32Mi
    falco:
      enabled: true
    tailing-sidecar-operator:
      enabled: true
    opentelemetry-operator:
      enabled: true
      createDefaultInstrumentation: true
      instrumentationNamespaces: "default"
    pvcCleaner:
      metrics:
        enabled: false
      logs:
        enabled: false
      resources:
        limits:
          memory: 256Mi
          cpu: 200m
        requests:
          memory: 64Mi
          cpu: 100m
