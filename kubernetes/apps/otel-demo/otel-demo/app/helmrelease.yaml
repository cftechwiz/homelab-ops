---
# yaml-language-server: $schema=https://kubernetes-schemas.falhalla.com/helmrelease_v2beta1.json
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: open-telemetry
  namespace: otel-demo
spec:
  interval: 15m
  chart:
    spec:
      chart: open-telemetry
      version: 0.19.0
      sourceRef:
        kind: HelmRepository
        name: opentelemetry-demo
        namespace: flux-system
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
values:
  opentelemetry-collector:
    config:
      exporters:
        otlpgrpc:
          endpoint: http://sumologic-sumologic-otelagent.monitoring:4317
      service:
        pipelines:
          traces:
            receivers: [otlp]
            processors: [batch]
            exporters: [otlpgrpc]
  components:
    frontendProxy:
      service:
        type: LoadBalancer
        externalIPs: ["${SVC_OTDEMO_ADDR}"]
        externalTrafficPolicy: Local
      ingress:
        dashboard:
          enabled: true
          ingressClassName: nginx
          annotations:
            hajimari.io/appName: "OTDEMO"
            hajimari.io/icon: simple-icons:eclipsemosquitto
            hajimari.io/group: Intranet Apps
          path: /
          pathType: Prefix
          hosts:
            - &host otdemo.intra.falhalla.com
          tls:
            - hosts:
                - *host
    frontend:
      env:
        - name: PUBLIC_OTEL_EXPORTER_OTLP_TRACES_ENDPOINT
          value: ${ SUMOLOGIC_RUMURL }